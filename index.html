<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CV Admin Form</title>
  <link rel="stylesheet" href="form.css" />
</head>
<body>
  <main>
    <h1>Save / Update Profile</h1>
    <p>Enter your data and press Save. The profile is stored in MongoDB via the API.</p>

    <form id="f">
      <label>Full Name* <input name="name" required placeholder="Soufiane Maakouk" /></label>
      <label>Headline <input name="headline" placeholder="Manager Digital Technology" /></label>
      <label>Avatar URL <input name="avatar" placeholder="https://..." /></label>
      <label>Email <input name="email" /></label>
      <label>Phone <input name="phone" /></label>
      <label>Location <input name="location" /></label>

      <label>Links (JSON)
        <textarea name="links" placeholder='[{"label":"LinkedIn","href":"https://..."}]'></textarea>
      </label>

      <label>Core Competencies (one per line)
        <textarea name="core_competencies" placeholder="Digital Transformation&#10;Agile & Scrum"></textarea>
      </label>

      <label>Technical Skills (one per line)
        <textarea name="technical_skills" placeholder="Python&#10;AWS"></textarea>
      </label>

      <label>Languages (JSON)
        <textarea name="languages" placeholder='[{"name":"English","level":"C1"}]'></textarea>
      </label>

      <label>Experience (JSON)
        <textarea name="experience" placeholder='[{"title":"Manager","company":"Org","location":"City","start":"Jan 2024","end":"Present","highlights":["Did X","Did Y"]}]'></textarea>
      </label>

      <label>Education (JSON)
        <textarea name="education" placeholder='[{"title":"Degree","institution":"School","year":"2024"}]'></textarea>
      </label>

      <label>Projects (JSON)
        <textarea name="projects" placeholder='[{"name":"Project","description":"What it is","url":"https://..."}]'></textarea>
      </label>

      <button type="submit">Save Profile</button>
      <div id="msg"></div>
    </form>
  </main>

  <script>
  // SET THIS to your API base:
  const API_BASE = "https://cv-api-s596.onrender.com";

  const $ = s => document.querySelector(s);

  function toLines(s) {
    return (s || "").split("\n").map(x => x.trim()).filter(Boolean);
  }

  function parseMultiJsonLines(txt) {
    if (!txt) return [];
    const lines = txt.split("\n").map(l => l.trim()).filter(Boolean);
    let arr = [];
    for (const line of lines) {
      try {
        const obj = JSON.parse(line);
        if (Array.isArray(obj)) {
          arr = arr.concat(obj);
        } else {
          arr.push(obj);
        }
      } catch (e) {
        console.warn("Invalid JSON line:", line);
      }
    }
    return arr;
  }

  function buildPayload(fd) {
    return {
      name: fd.get("name"),
      headline: fd.get("headline"),
      avatar: fd.get("avatar"),
      email: fd.get("email"),
      phone: fd.get("phone"),
      location: fd.get("location"),
      links: parseMultiJsonLines(fd.get("links")),
      core_competencies: toLines(fd.get("core_competencies")),
      technical_skills: parseMultiJsonLines(fd.get("technical_skills")),
      languages: parseMultiJsonLines(fd.get("languages")),
      experience: parseMultiJsonLines(fd.get("experience")),
      education: parseMultiJsonLines(fd.get("education")),
      projects: parseMultiJsonLines(fd.get("projects"))
    };
  }

  // Save form
  $("#f").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const payload = buildPayload(fd);

    $("#msg").textContent = "Saving…";
    try {
      const res = await fetch(`${API_BASE}/profiles`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed to save");
      $("#msg").innerHTML = `Saved ✅ — <a href="https://thebeastmaak.github.io/cv-page/?name=${encodeURIComponent(payload.name)}" target="_blank">View profile</a>`;
    } catch (err) {
      $("#msg").textContent = "Error: " + err.message;
    }
  });

  // Preview button
  $("#previewBtn").addEventListener("click", (e) => {
    e.preventDefault();
    const fd = new FormData($("#f"));
    const payload = buildPayload(fd);
    $("#previewOutput").textContent = JSON.stringify(payload, null, 2);
  });
</script>
</body>
</html>
